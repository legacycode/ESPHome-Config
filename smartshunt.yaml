# Victron SmartShunt Konfiguration
# Beispielkonfiguration: https://github.com/KinDR007/VictronMPPT-ESPHOME/blob/main/smartshunt-esp8266-example.yaml

substitutions:
  # Der interne Name, der von ESPHome verwendet wird (klein, ohne Leerzeichen, Bindestriche OK)
  devicename: "smartshunt"

  # Der Anzeigename in Home Assistant (ohne Umlaute für MQTT-Kompatibilität)
  friendly_name: "SmartShunt"

  # Beschreibung, was dieses Gerät macht
  device_comment: "Victron SmartShunt Batteriemonitor"

# Remote extensions (API encryption, OTA, MQTT, Web Server, Captive Portal)
packages:
  common:
    url: https://github.com/legacycode-esphome/ESPHome-Config.git
    file: common.yaml
    ref: main
    refresh: 0s

# Board-Konfiguration (M5Stack AtomS3)
esp32:
  board: m5stack-atoms3
  variant: esp32s3
  framework:
    type: arduino

# Externe Komponente für Victron
external_components:
  - source: github://KinDR007/VictronMPPT-ESPHOME@main

# UART-Konfiguration für Victron VE.Direct
# Nur RX-Pin, da VE.Direct Text Protocol read-only ist
uart:
  id: uart_0
  rx_pin: GPIO1
  baud_rate: 19200
  rx_buffer_size: 256

# Victron Platform
victron:
  id: victron0
  uart_id: uart_0

# Victron Sensoren
sensor:
  - platform: victron
    victron_id: victron0
    battery_voltage:
      name: "${friendly_name} Batterie Spannung"
      icon: "mdi:battery-charging"
      device_class: voltage
      state_class: measurement
    auxiliary_battery_voltage:
      name: "${friendly_name} Hilfsbatterie Spannung"
      icon: "mdi:battery-outline"
      device_class: voltage
      state_class: measurement
    battery_current:
      name: "${friendly_name} Batterie Strom"
      icon: "mdi:current-dc"
      device_class: current
      state_class: measurement
    instantaneous_power:
      name: "${friendly_name} Momentanleistung"
      icon: "mdi:flash"
      device_class: power
      state_class: measurement
    consumed_amp_hours:
      name: "${friendly_name} Verbrauchte Ah"
      icon: "mdi:battery-minus"
    state_of_charge:
      name: "${friendly_name} Ladezustand"
      icon: "mdi:battery-70"
      device_class: battery
      state_class: measurement
    time_to_go:
      name: "${friendly_name} Restlaufzeit"
      icon: "mdi:timer-outline"
    depth_of_the_deepest_discharge:
      name: "${friendly_name} Tiefste Entladung"
      icon: "mdi:battery-alert"
    depth_of_the_last_discharge:
      name: "${friendly_name} Letzte Entladung"
      icon: "mdi:battery-minus-variant"
    depth_of_the_average_discharge:
      name: "${friendly_name} Durchschnittliche Entladung"
      icon: "mdi:battery-50"
    cumulative_amp_hours_drawn:
      name: "${friendly_name} Kumulierte Ah entnommen"
      icon: "mdi:battery-minus-outline"
    min_battery_voltage:
      name: "${friendly_name} Min Batterie Spannung"
      icon: "mdi:battery-low"
      device_class: voltage
      state_class: measurement
    max_battery_voltage:
      name: "${friendly_name} Max Batterie Spannung"
      icon: "mdi:battery-high"
      device_class: voltage
      state_class: measurement
    last_full_charge:
      name: "${friendly_name} Letzte Vollladung"
      icon: "mdi:battery-charging-100"
    min_auxiliary_battery_voltage:
      name: "${friendly_name} Min Hilfsbatterie Spannung"
      icon: "mdi:battery-low"
      device_class: voltage
      state_class: measurement
    max_auxiliary_battery_voltage:
      name: "${friendly_name} Max Hilfsbatterie Spannung"
      icon: "mdi:battery-high"
      device_class: voltage
      state_class: measurement
    amount_of_discharged_energy:
      name: "${friendly_name} Entladene Energie"
      icon: "mdi:battery-arrow-down"
      unit_of_measurement: "kWh"
      accuracy_decimals: 2
      device_class: energy
      state_class: total_increasing
      filters:
        - multiply: 0.001  # Wh → kWh
    amount_of_charged_energy:
      name: "${friendly_name} Geladene Energie"
      icon: "mdi:battery-arrow-up"
      unit_of_measurement: "kWh"
      accuracy_decimals: 2
      device_class: energy
      state_class: total_increasing
      filters:
        - multiply: 0.001  # Wh → kWh
    dc_monitor_mode_id:
      name: "${friendly_name} DC Monitor Modus ID"
      icon: "mdi:information-outline"

# Victron Text-Sensoren
text_sensor:
  - platform: victron
    victron_id: victron0
    model_description:
      name: "${friendly_name} Modellbeschreibung"
      icon: "mdi:information"
    firmware_version:
      name: "${friendly_name} Firmware Version"
      icon: "mdi:chip"
    dc_monitor_mode:
      name: "${friendly_name} DC Monitor Modus"
      icon: "mdi:monitor-dashboard"
